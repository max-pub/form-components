
<dom-module id="ajax-stream">
    <template>
    </template>

    <script>
        Polymer({
            is: 'ajax-stream',

            properties:{
                url: {
                    type: String,
                    observer: 'urlChange'
                }
            },
            ready:function(){
            },

            urlChange: function(){
                this.debounce('stream',function(){
                    this.stream(this.url);
                }.bind(this), 200);
            },

            base: function(url, options){
                if(!options) options = {post:''};
                var request = new XMLHttpRequest();
                if (!request) return false;
                var method = (options.post) ? "POST" : "GET";
                request.open(method,url,true);
                if (options.post)
                    request.setRequestHeader('Content-type','application/x-www-form-urlencoded');
                request.send(options.post);
                return request;
            },
            
            

            stream: function (url){
                console.log('stream',this.url);
                var options = {splitString:"\n\n\n"};
                var request = this.base(url, options);
                if(!request) return false;
            
                request.onreadystatechange = function () {
                    if (request.readyState == 4){
                        this.fire('finish', request.responseText);
                        this.fire('update', request.response.substring(lastPos)); // last bits that havent been covered by "onprogress"
                    }
                }.bind(this);
                
                var lastPos = 0;
                request.onprogress = function(){
                    while(1){
                        var pos = request.response.indexOf(options.splitString, lastPos);
                        if(pos==-1) break;
                        var item = request.response.substring(lastPos, pos);
                        lastPos = pos+options.splitString.length;
                        this.fire('update',item);
                    }
                }.bind(this);
                return request;
            }
    
    

        });
    </script>
</dom-module>

