
<polymer-element name="avatar-edit" attributes="">
    <template>
        <style>
            .avatar{
                width:128px;
                height:128px;
                border:1px solid silver;
            }
        </style>
        <img class='avatar' src=''/>

        <form id='form' action='{action}' target='target' method='post' enctype='multipart/form-data' style='visibility:hidden; height:0px;'>
            <input name='picUpload' type='file' maxlength='100000' accept='text/*' onchange='$(this).parent().submit(picUploadLoading).submit();'>
            <iframe id='target' style='display:none;' onload='picUploadResult(this);'></iframe>
        </form>
    </template>

    <script>
        Polymer({
        });
    </script>
</polymer-element>


picUploadHTML = "";

picUploadInit = function(target,init){
    var img = $(target).clone();
    if(init){ img.attr('src',init); }
    if(!img.attr('src')){img.attr('src',img.attr('picUploadDefault'));}
    var name = img.attr('picUpload');
    var frame = $("<div id='{0}_picUploadContainer' class='picUpload'>".v(name));
    var hidden = $("<input type='hidden'/>").attr('name',name).val(img.attr('src'));
    var upload = $(picUploadHTML.v({id:name,action:'/api/upload.php'}));
    frame.append(img).append(hidden);
    $('body').append(upload);
    img.click(function(ev){$('#'+name+'_picUploadForm [name=picUpload]').trigger('click');});
    $(target).replaceWith(frame);
}
picUploadLoading = function(event){
    c.log('picUpload.loading',event,$(event));
    event.stopPropagation();
    var img = $(event.target).parent().find('img');
    img.attr('src',img.attr('picUploadLoading'));
}
picUploadResult = function(iframe){
    c.log('picUpload.result',iframe);
    var result = iframe.contentWindow.document.body.innerHTML;
    if(!result){return this;}
    var name = $(iframe).attr('name').replace('_picUploadFrame','');
    //var frame = $(iframe).parent().parent();
    var container = $('#'+name+'_picUploadContainer');
    c.log('iframe',name,result,container);
    container.find('img').attr('src',result);
    container.find('[type=hidden]').val(result);

}


$(document).bind("DOMNodeInserted",function(ev){
  $(ev.target).find('[picUpload]').not('.mx-picupload').addClass('mx-picupload').each(function(){
    picUploadInit(this);
  });
});


c.log('picUpload.js loaded');


/*
    this.onClick = function(ev){
        var el = $(ev.target);
        c.log('picaction-el',el);
        //if(!$('[name=uploader]').size()){picAppend();}
        $('[name=picUpload]').trigger('click');
        $('[name=uploader]').attr('callback',el.attr('picResult'));
        //$('form.picUploader').attr('callback',el.attr('picResult'));
    }
function picResult(iframe){
    var result = iframe.contentWindow.document.body.innerHTML;
    if(!result){return this;}
    var frame = $(iframe).parent().parent();
    frame.find('img').attr('src',result);
    frame.find('[type=hidden]').val(result);

}
function picLoading(event){
    c.log(event,$(event));
    event.stopPropagation();
    $(event.target).parent().find('img').attr('src','/view/icons/loading.gif');
    //event.cancelBubble = true;
    //$(event).stopPropagation();
    //return false;
//    $('[picUpload]').attr('src','/view/icons/loading.gif');
}



function picUploadable(ev){
    var el = $(ev.target);
    el.click(picAction);
}
*/
//$(this).parent().submit();
//onsubmit='picLoading(event); return false;'
//picSubmit(event);

//ps = function(el){console.log('picup',el);}
/*
picSubmit = function(event){
    //$(event.target).parent().bind('submit',false);
    $(event.target).parent().bind('submit',picLoading).submit();

}
*/

/*
function picAction(ev){
    var el = $(ev.target);
    c.log('picaction-el',el);
    if(!$('[name=uploader]').size()){picAppend();}
    $('[name=picUpload]').trigger('click');
    $('[name=uploader]').attr('callback',el.attr('picResult'));
    //$('form.picUploader').attr('callback',el.attr('picResult'));
}

*/
